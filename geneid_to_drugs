bcgenes = input('Enter Gene Name: ')
import requests
import numpy as np
import pandas as pd
import json
#converting gene names to Ensembl ids
import mygene
mg = mygene.MyGeneInfo()
mgres = mg.querymany(bcgenes, scopes='symbol,alias',fields='ensembl.gene', species='human')

def drugtable(bcgenes):
    drugfields = ['target.gene_info.symbol',
                  'target.target_class',
                  'evidence.target2drug.action_type',
                  'disease.efo_info.label',
                  'unique_association_fields.chembl_molecules','disease.id',
                  'drug','id']
    payload = {"target":bcgenes, 'datatype':['known_drug'],'fields':drugfields}
    r = requests.post('https://platform-api.opentargets.io/v3/platform/public/evidence/filter',json=payload)

    for e in r.json()['data']:
        yield (e['target']['gene_info']['symbol'],
              e['target']['target_class'][0],
              e["unique_association_fields"]['chembl_molecules'],
              e['evidence']['target2drug']['action_type'],
              e['drug']['molecule_name'],
              e['drug']['molecule_type'],
              e['drug']["max_phase_for_all_diseases"]['numeric_index'],
              e['disease']['id'],
              e['disease']['efo_info']['label'],
              e['id']
              )

bcgenes_ensg = []
for x in mgres:
    try:
        bcgenes_ensg.append(x['ensembl']['gene'])
    except KeyError:
        pass
    except TypeError:
        bcgenes_ensg.append(x['ensembl'][0]['gene'])
bcgenes_ensg[:3]

genes_chunked = [bcgenes_ensg[i:i + 50] for i in range(0, len(bcgenes_ensg), 50)]

cols = ['Target','Target Class','Chembl Uri','MOA','Molecule Name','Molecule Type','Phase','EFO','Indication','ID']

drugtable = pd.concat([pd.DataFrame(drugtable(g), columns=cols) for g in genes_chunked])
numrows = drugtable.head().shape[0]
import csv
fixbool = False
with open('efo_hp_tags.csv', 'r') as f:
    reader = csv.reader(f)
    list_of_EFOs = list(reader)
    print(list_of_EFOs)
    for a in range(0, numrows):
        drugstring = drugtable.head().iloc[a,7]
        if any (drugstring in s for s in list_of_EFOs):
            print("success")
            fixbool = True
            print(drugtable.head().iloc[a,:])
            drugtable.head().iloc[a,:].to_json(r'/Users/dauphin/Documents/kfile.json')
            #dfObj = pd.DataFrame(columns=['Target','Target Class','Chembl Uri','MOA','Molecule Name','Molecule Type','Phase','EFO','Indication','ID'])
        else:
            drugtable.drop([drugtable.head().iloc[a,:]])
if fixbool == True:
    drugtable.head().to_json(r'/Users/dauphin/Documents/kfile.json')
